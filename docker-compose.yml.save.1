version: '3.7'
services:
  node1:
    #command: /bin/sh -c "chmod -R o+rwx /var/atlassian/jira-shared-home"
    image: atlassian/jira-software:8.13.4
    ports:
      - 9090:8080
    volumes:
      - ./artifacts/jira-home-node1:/var/atlassian/application-data/jira:z
      - ./artifacts/jira-shared-home:/var/atlassian/jira-shared-home:z
    environment:
      CATALINA_OPTS: -Datlassian.cluster.scale=true -DjvmRoute=node1

#  node2:
#    image: atlassian/jira-software:8.13.4
#    ports:
#      - 9091:8080
#    volumes:
#      - ./artifacts/jira-home-node2:/var/atlassian/application-data/jira:z
#      - ./artifacts/jira-shared-home:/var/atlassian/jira-shared-home:z
#    environment:
#      CATALINA_OPTS: -Datlassian.cluster.scale=true -DjvmRoute=node2

  proxy:
    image: haproxy:2.3
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:z

  certbot:
    image: certbot/dns-route53
    volumes:
      - ./certs:/etc/letsencrypt
      - ./acme-challenge:/var/www/acme-challenge:z
      - ./certbot-digitalocean.ini:/etc/letsencrypt/certbot-digitalocean.ini
      - ./certbot_script.sh:/usr/local/bin/certbot_script.sh:z

     #- ./certs:/etc/letsencrypt
     #- ./acme-challenge:/var/www/acme-challenge
     #- ./artifacts/certbot-digitalocean.ini:/etc/letsencrypt/certbot-digitalocean.ini
   #environment:
     #- CERTBOT_DOMAIN='azsertcenter.az'
     #- DIGITALOCEAN_API_KEY='dop_v1_68b80d1b63b9b14216331572a385f54110c501423d8ae6b5b3f6e8ce46aaf731'
   # command: ["certonly", "--webroot", "--webroot-path", "/var/www/acme-challenge", "-d", "teso.az", "--agree-tos", "--email", "oiskenderov@gmail.com", "--non-interactive", "--quiet"]
   # command: certonly --webroot --webroot-path /var/www/acme-challenge --cert-name -d teso.az --agre-tos --email oiskenderov@gmail.com
    command: /bin/sh -c ["mkdir", "-p", "/var/www/acme-challenge"]
    command: /bin/sh -c [ "sleep 30", "chown", "www-data:www-data", "/var/www/acme-challenge" ]
    command: [ "certonly", "--webroot", "--webroot-path", "/var/www/acme-challenge", "-d", "azsertcenter.az", "-d", "www.azsertcenter.az", "--agree-tos", "--email", "oiskenderov@gmail.com"]
   # command: >
   #   sh -c "mkdir -p /var/www/acme-challenge && certbot certonly --webroot --webroot-path /var/www/acme-challenge -d azsertcenter.az --agree-tos --email oiskenderov@gmail.com --non-interactive --quiet"
   #  command: /bin/sh -c "./certbot_script.sh"
   #   - sh
   #   - -c
   #   - "mkdir -p /var/www/acme-challenge && certbot certonly --webroot --webroot-path /var/www/acme-challenge -d azsertcenter.az --agree-tos --email oiskenderov@gmail.com --non-interactive --quiet"


#  certbot:
#    image: certbot/dns-digitalocean
#    volumes:
#      - ./certs:/etc/letsencrypt
#      - ./acme-challenge:/var/www/acme-challenge
#      - ./certbot-digitalocean.ini:/etc/letsencrypt/certbot-digitalocean.ini
#    command: certonly --webroot --webroot-path /var/www/acme-challenge --cert-name teso.az --agree-tos --email oiskenderov@gmail.com
#    environment:
#      - CERTBOT_DOMAIN='teso.az'
#      - DIGITALOCEAN_API_KEY='dop_v1_68b80d1b63b9b14216331572a385f54110c501423d8ae6b5b3f6e8ce46aaf731'

  database:
    image: postgres:10.5-alpine
    volumes:
      - ./artifacts/postgresql-data:/var/lib/postgresql/data:z
      - ./postgre-db-init.sql:/docker-entrypoint-initdb.d/postgre-db-init.sql:z
    ports:
      - 5432:5432
    environment:
      - POSTGRES_PASSWORD=1234
      - POSTGRES_USER=postgres
networks:
  haproxy_network:
    external: true
